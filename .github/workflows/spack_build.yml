name: Spack Builds

on: [push]

jobs:
  hiop_spack_builds:
    # https://spack.io/spack-binary-packages/
    # Spack public build cache is only 18.04
    # https://oaciss.uoregon.edu/e4s/inventory.html
    # E4S cache supports other OS, mostly 20.04 for x86_64
    # E4S cache supports a tagged version of spack, hence 0.19.1
    runs-on: ubuntu-20.04
    container: spack/ubuntu-focal:v0.19.1
    strategy:
      matrix:
        spack_spec:
          - hiop@develop+mpi~raja~shared~kron~sparse ^openmpi
          - hiop@develop~mpi~raja~shared~kron~sparse
          - hiop@develop~mpi+raja~shared~kron~sparse

            # We will need coinhsl for this, but what are the rules for using
            # a coinhsl tarball?
            # - hiop@develop~mpi~raja~shared~kron+sparse

    name: Build HiOp with Spack
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Build Environment
        env:
          SPACK_SPEC: ${{ matrix.spack_spec }}
        run: |
          ls && pwd
          . /opt/spack/share/spack/setup-env.sh
          spack debug report
          # Just use the public mirror to bootstrap concretizer
          spack mirror add spack_public_mirror https://binaries.spack.io/develop
          spack buildcache keys --install --trust
          # Need to create an environment to install hiop in the action's branch
          spack env create -d ./spack-env
          spack env activate ./spack-env
          spack add $SPACK_SPEC target=x86_64
          spack develop --path $(pwd) --no-clone hiop@develop
          spack concretize --reuse
          # Add E4S mirror for faster builds
          spack mirror add E4S https://cache.e4s.io
          spack buildcache keys --install --trust
          spack --stacktrace install --fail-fast

